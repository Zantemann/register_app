# Security Documentation

This document outlines the security aspects of the application, including authentication, authorization, session handling, and data handling and storage.

## Authentication

The application uses **Twilio Verify API** for phone number-based passwordless authentication via SMS. Check more from [Twilio Verify API Documentation](https://www.twilio.com/docs/verify/api).

**Process**:

1. Users provide their phone number, and the application checks that it exists in the invitation list database.
2. The application requests Twilio to send a One-Time Password (OTP) via SMS to the provided phone number.
3. After the user receives the OTP, it is sent to Twilio to be verified.
4. Upon successful verification, the user gains access to the application.

**Security**:

- Twilio Verify API takes fully care of the authentication process from sending the OTPs via SMS to verifying them.
- Twilio ensures the security of OTPs by implementing critical measures such as expiration, API and SMS rate limiting, and monitoring for suspicious activity.
- Various security aspects of authentication, such as OTP expiration time, SMS rate limits, and service availability, can be configured based on application requirements.
- The application formats and validates phone numbers before sending requests to Twilio to minimize unnecessary API usage.

**Risks**:

- Unauthorized access is possible if someone gains access to the invited user's phone and retrieves the OTP.
- The OTP provides access to the application during its validity period, increasing the risk of unauthorized access if the OTP is leaked.
- Abuse of the OTP service can lead to increased costs, even with rate limiting in place.

## Session Handling

After successful authentication, a new user session is created to verify the user's access to the application. The session is saved in the database and accessed via cookies on the client side.

**Process**:

1. A new session is created upon successful authentication.
2. Each session is identified by a unique token that is generated by the application using a cryptographically secure random number generator.
3. The session is stored in the database and linked to the user's data to manage access and authorization within the application.
4. The session is accessed in the application via cookies.

**Security**:

- Cookies are configured with the `HttpOnly` and `Secure` flags to prevent client-side access and ensure transmission over HTTPS.
- The `SameSite` attribute is set to prevent cross-site request forgery (CSRF) attacks.
- Sessions are automatically invalidated after a predefined expiration time and are also deleted from the database to prevent unauthorized access.

**Risks**:

- Session hijacking is possible if cookies are intercepted, though mitigated by HTTPS and secure cookie flags.
- Users who fail to log out on shared devices may leave their sessions vulnerable to unauthorized access.

## Data Handling and Storage

User's personal data and session information are stored in a MongoDB database and are accessible only to the respective user. Personal data is shared between the main guest and their additional guests (e.g., "avec").

**Process**:

1. When a user is invited to an event, their data is stored in the database.
2. Users can edit certain details about themselves and their additional guests, such as attendance status and preferences, and save these changes to the database.

**Security**:

- User inputs are sanitized and validated before being saved to the database to prevent injection attacks and ensure data integrity.
- Users can only access and edit their own data and the data of their additional guests.
- Access to the database is restricted to authorized services, ensuring that only authenticated and authorized operations are performed.

**Risks**:

- A guest can view and edit the data of additional guests, which may lead to privacy concerns.
- The additional guests' data can potentially be edited without their knowledge, leading to potential misuse or conflicts.

# OWASP 2021 Top 10 Overview

Evaluating Register App against the OWASP 2021 Top 10 security risks.

## A01:2021-Broken Access Control

**Findings**:

- The application checks user authorization at the API level using session validation
- Each user can only access/modify their own and their guests' data through API endpoint checks
- Missing API level rate limiting on critical API endpoints:
  - OTP request endpoint: `/api/otp/send/[phoneNumber]`
  - OTP verification endpoint: `/api/otp/verify/[phoneNumber]`
  - User data endpoint: `/api/users/[userId]`

**Recommendations**:

- Implement middleware for consistent access control
- Implement rate limiter for critical api routes

**Reflection**:

- The application currently has only one secured route. While middleware for consistent access control is not immediately necessary, it would be beneficial for future application expansion.
- OTP-related endpoints already have rate limiting through the Twilio API:

  - Additional endpoint-level rate limiting would provide more control but is not critical
  - Implementing rate limiting for the user data endpoint would help prevent database abuse

## A02:2021-Cryptographic Failures

**Findings**:

- Session management:

  - Session IDs are generated using `crypto.randomBytes`, which is cryptographically secure.
  - Session cookies use secure flags (HttpOnly, Secure, SameSite) with cookie expiration time.
  - Sessions are stored and validated using database to exclude risk of session manipulation.

- Sensitive data such as API keys and connection strings are stored in environment variables.
- There is no encryption for sensitive user data stored in the database.

**Recommendations**:

- Encrypt sensitive data in the database using a strong encryption algorithm.

**Reflection**:

- Current session handling is cryptographically secure.
- The main risk is unencrypted sensitive data in the database.

## A03:2021-Injection

**Findings**:

- API endpoints accept user input without comprehensive validation:
  - Phone numbers are partially sanitized using regex
  - OTP codes are validated only for length
  - User data updates lack input validation
- MongoDB queries use Mongoose schema which provides basic protection

**Recommendations**:

- Implement comprehensive input validation

**Reflection**:

- Current implementation relies mostly on Mongoose schema validation
- Adding proper input validation would prevent injection attacks and ensure data integrity
- Input validation should be implemented both client-side and server-side

## A04:2021-Insecure Design

## A05:2021-Security Misconfiguration

## A06:2021-Vulnerable and Outdated Components

## A07:2021-Identification and Authentication Failures

## A08:2021-Software and Data Integrity Failures

## A09:2021-Security Logging and Monitoring Failures

## A10:2021-Server-Side Request Forgery

# Future Improvements
